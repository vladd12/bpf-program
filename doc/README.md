# Документация на библиотеку iec_core

#### Содержание

1. [Архитектура](#architecture)
2. [ValueExchangeBuffer](#valueexchangebuffer)
3. [StaticBuffer](#staticbuffer)
4. [Engine](#engine)
5. [Handler](#handler)
6. [Endpoint](#endpoint)

<a name="architecture"/>
## Архитектура

![Схема](/doc/img/01.svg)

Библиотека предполагает работу с несколькими потоками, каждый из которых выполняет свою задачу:

- **Engine Thread**: запускает объект **Engine**, который читает и фильтрует сетевой трафик, а затем записывает данные в **ValueExchangeBuffer** для передачи данных в другой поток;
- **Handler Thread**: запускает объект **Handler**, который читает полученные от *Engine* данные из *ValueExchangeBuffer* и обрабатывает их согласно внутренней логике. После этого обработчик записывает данные в другой *ValueExchangeBuffer* для передачи третьему потоку;
- **Endpoint Thread**: запускает объект **Endpoint**, который читает полученные от *Handler* данные из *ValueExchangeBuffer* и отправляет их в конечную точку.

Пользователь не должен вручную создавать потоки или объекты типов *Engine*, *Handler* и *Endpoint*. Для этого в библиотеке есть шаблонный класс **PipelineBuilder**, который принимает в качестве типов указанные пользователем *Engine*, *Handler* и *Endpoint*.

<a name="valueexchangebuffer"/>
## ValueExchangeBuffer

Эта шаблонная структура данных предоставляет возможность обмена данными между потоками. В качестве типа указывается тип буффера, хранимый в структуре данных (зачастую в ней хранится **StaticBuffer** указанного размера).

Необходимость определять данную структуру вручную пользователем была выбрана для того, чтобы можно было исследовать различные реализации обмена данными между потоками. Например, сейчас в библиотеке есть следующие классы, удовлетворяющие требованиям *ValueExchangeBuffer*:

- **ValueExchangeLockFree**: предоставляет интерфейс для обмена данными между потоками без блокировок и мьютексов. Попытки избежать блокировки разумно предпринимать, т.к. во время блокировки потока ОС в праве переключить неактивное ядро на другую задачу. В результате переключения контекста потоков всегда инвалидируется кэш процессора. В итоге получаем частые кэш-промахи, и как результат большие затраты на доступ к ОЗУ.
- **ValueExchangeBlocking**: предоставляет интерфейс для обмена данными между потоками с блокировкой доступа к разделяемому буфферу с помощью мьютекса.

<a name="staticbuffer"/>
## StaticBuffer

Имплементация буффера фиксированного размера с аллокацией массива байт на стеке. Помимо этого имеет беззнаковые смещения, чтобы получать указатель на свободную область буффера, или непрочитанную область памяти.

<a name="engine"/>
## Engine

В данный момент в библиотеке *iec_core* имеются следующие сущности типа *Engine*:

- **BPFEngine**: обработчик сетевого трафика с *eBPF* фильтром.
  - **Плюсы**: работает.
  - **Минусы**: тянет за собой тяжёлый *LLVM backend* для компиляции BPF-программы в байткод.
- **PCAPEngine** (*INCOMPLETE*): обработчик сетевого трафика с использованием **pcap** фильтрации и технологии *kernel bypass*. Мотивация к использованию: не тянуть тяжёлые LLVM и bcc. **Незавершён**.
- **NativeEngine** (*INCOMPLETE*): нативный обработчик сетевого трафика, т.е. обработка производится в самом потоке непосредственно после чтения данных. Мотивация к использованию: проверить, насколько плохо будет работать нативный обработчик трафика. В теории может оказаться, что BPF и pcap велосипеды, внезапно, не нужны для фильтрации. **Незавершён**.

<a name="handler"/>
## Handler

Обрабатывает полученные от *Engine* данные. В настоящий момент в библиотеке *iec_core* имеются следующие сущности типа *Handler*:

- **NumberCrusher** (*INCOMPLETE*): поток, в котором происходит вся математика, вычисления и магия. Результат работы отдаёт дальше *Endpoint*. **Незавершён**.

<a name="endpoint"/>
## Endpoint

Конечная точка для отправки обработанных данных. В настоящий момент в библиотеке *iec_core* отсутствуют реализации сущности *Endpoint*. Предлагаемые к реализации сущности:

- **NetworkEndpoint**: отправляет обработанные данные в сеть (сокет) с указанными параметрами;
- **FileEndpoint**: записывает обработанные данные в указанный файл;
- **IEC104Endpoint**: отправляет обработанные данные спорадически по протоколу IEC 60870-5-104;
- **SharedMemoryEndpoint**: отправляет обработанные данные в разделяемую память дальше другому процессу (см. *boost::interprocess*).
